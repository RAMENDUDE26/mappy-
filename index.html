<!DOCTYPE html>
<html>
<head>
  <title>Mappy (NES) Emulator</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
    canvas { border: 3px solid #000; background: #000; }
  </style>
</head>
<body>
  <h1>Mappy (NES) Emulator</h1>
  <canvas id="nes-canvas" width="256" height="240"></canvas>
  <script src="https://unpkg.com/jsnes/dist/jsnes.min.js"></script>
  <script>
    const base64ROM = 'TkVTGgEBAQAAAAAAAAAAAENPUFlSSUdIVCAxOTgzIDE5ODQgTkFNQ08gTFRELkFMTCBSSUdIVFMgUkVTRVJWRUR42KJfmqkAjQAgAAACAAABAAEAAAAEAAAEAAABAgQDAwMDAwMDBgYGBgYGBgYGBwcHBwcHBwcHBwcICAgICAgICAgIC...'; // Truncated

    function base64ToArrayBuffer(base64) {
      const binaryString = atob(base64);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes;
    }

    const canvas = document.getElementById('nes-canvas');
    const context = canvas.getContext('2d');
    const imageData = context.getImageData(0, 0, 256, 240);

    const nes = new jsnes.NES({
      onFrame(framebuffer_24) {
        for (let i = 0; i < framebuffer_24.length; i++) {
          imageData.data[i] = framebuffer_24[i];
        }
        context.putImageData(imageData, 0, 0);
      },
      onStatusUpdate: console.log,
      onAudioSample: () => {}
    });

    const romData = base64ToArrayBuffer(base64ROM);
    nes.loadROM(romData);

    // Start game loop
    function onAnimationFrame() {
      nes.frame(); // run one emulation frame
      requestAnimationFrame(onAnimationFrame);
    }

    requestAnimationFrame(onAnimationFrame); // kick off the loop
  </script>
</body>
</html>
