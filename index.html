<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Mappy Emulator</title>
  <style>
    html, body {
      margin: 0;
      background: black;
      overflow: hidden;
      height: 100%;
      width: 100%;
    }
    canvas {
      display: block;
      width: 100vw;
      height: 100vh;
      image-rendering: pixelated;
    }
  </style>
</head>
<body>
  <canvas id="nes-canvas" width="256" height="240"></canvas>
  <script src="https://unpkg.com/jsnes/dist/jsnes.min.js"></script>
  <script>
    const base64ROM = 'TkVTGgEBAQAAAAAAAAAAAENPUFlSSUdIVCAxOTgzIDE5ODQgTkFNQ08gTFRELkFMTCBSSUdIVFMgUkVTRVJWRUR42KJfmqkAjQAgAAACAAABAAEAAAAEAAAEAAABAgQDAwMDAwMDBgYGBgYGBgYGBwcHBwcHBwcHBwcICAgICAgICAgIC...'; // Truncated

    function base64ToArrayBuffer(base64) {
      const binaryString = atob(base64);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes;
    }

    const canvas = document.getElementById('nes-canvas');
    const context = canvas.getContext('2d');
    const imageData = context.getImageData(0, 0, 256, 240);

    const nes = new jsnes.NES({
      onFrame: function(framebuffer_24) {
        for (let i = 0; i < framebuffer_24.length; i++) {
          const offset = i * 4;
          const color = framebuffer_24[i];
          imageData.data[offset]     = (color >> 16) & 0xFF; // R
          imageData.data[offset + 1] = (color >> 8)  & 0xFF; // G
          imageData.data[offset + 2] = color & 0xFF;          // B
          imageData.data[offset + 3] = 0xFF;                 // A
        }
        context.putImageData(imageData, 0, 0);
      },
      onStatusUpdate: console.log,
      onAudioSample: () => {}
    });

    const romData = base64ToArrayBuffer(base64ROM);
    nes.loadROM(romData);

    function animate() {
      nes.frame(); // this is essential for the game to advance
      requestAnimationFrame(animate);
    }

    animate(); // start the loop
  </script>
</body>
</html>
