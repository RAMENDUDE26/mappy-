<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Mappy NES Emulator</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      overflow: hidden;
      height: 100%;
      width: 100%;
    }
    canvas {
      display: block;
      width: 100vw;
      height: 100vh;
      image-rendering: pixelated;
    }
  </style>
</head>
<body>
  <canvas id="nes-canvas" width="256" height="240"></canvas>
  <script src="https://unpkg.com/jsnes/dist/jsnes.min.js"></script>
  <script>
    const base64ROM = 'TkVTGgEBAQAAAAAAAAAAAENPUFlSSUdIVCAxOTgzIDE5ODQgTkFNQ08gTFRELkFMTCBSSUdIVFMgUkVTRVJWRUR42KJfmqkAjQAgAAACAAABAAEAAAAEAAAEAAABAgQDAwMDAwMDBgYGBgYGBgYGBwcHBwcHBwcHBwcICAgICAgICAgIC...'; // Truncated

    function base64ToArrayBuffer(base64) {
      const binaryString = atob(base64);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes;
    }

    const canvas = document.getElementById('nes-canvas');
    const context = canvas.getContext('2d');
    const framebuffer = new Uint32Array(256 * 240);
    const imageData = context.createImageData(256, 240);

    const nes = new jsnes.NES({
      onFrame: function(buffer) {
        for (let i = 0; i < buffer.length; i++) {
          const color = buffer[i];
          imageData.data[i * 4 + 0] = (color >> 16) & 0xFF; // R
          imageData.data[i * 4 + 1] = (color >> 8) & 0xFF;  // G
          imageData.data[i * 4 + 2] = color & 0xFF;         // B
          imageData.data[i * 4 + 3] = 0xFF;                 // A
        }
        context.putImageData(imageData, 0, 0);
      },
      onStatusUpdate: console.log,
      onAudioSample: () => {}
    });

    const romData = base64ToArrayBuffer(base64ROM);
    nes.loadROM(romData);

    function animate() {
      nes.frame();
      requestAnimationFrame(animate);
    }

    requestAnimationFrame(animate);
  </script>
</body>
</html>
